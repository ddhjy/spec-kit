---
description: 基于现有设计产物，为该功能生成可执行、按依赖排序的 tasks.md。
handoffs: 
  - label: 一致性分析
    agent: speckit.analyze
    prompt: 请运行跨产物一致性分析
    send: true
  - label: 开始实现
    agent: speckit.implement
    prompt: 请按阶段开始实现
    send: true
scripts:
  sh: scripts/bash/check-prerequisites.sh --json
  ps: scripts/powershell/check-prerequisites.ps1 -Json
---

## 用户输入

```text
$ARGUMENTS
```

在继续之前，你 **必须** 先考虑用户输入（如果不为空）。

## 大纲

1. **准备**：在仓库根目录运行 `{SCRIPT}`，并解析 FEATURE_DIR 与 AVAILABLE_DOCS 列表。所有路径必须是绝对路径。参数中若包含单引号（例如 "I'm Groot"），请使用转义：例如 'I'\''m Groot'（或尽量用双引号："I'm Groot"）。

2. **加载设计文档**：从 FEATURE_DIR 读取：
   - **必需**：plan.md（技术栈、依赖、结构）、spec.md（带优先级的用户故事）
   - **可选**：data-model.md（实体）、contracts/（API 端点）、research.md（技术决策）、quickstart.md（测试场景）
   - 注意：并非所有项目都有全部文档；请基于现有内容生成 tasks。

3. **执行任务生成工作流**：
   - 读取 plan.md 并提取技术栈、依赖与项目结构
   - 读取 spec.md 并提取用户故事及其优先级（P1、P2、P3……）
   - 若存在 data-model.md：提取实体并映射到用户故事
   - 若存在 contracts/：将端点映射到用户故事
   - 若存在 research.md：提取决策以生成准备阶段任务
   - 按用户故事组织任务（见下方“任务生成规则”）
   - 生成依赖图，展示用户故事完成顺序
   - 为每个用户故事生成并行执行示例
   - 校验任务完整性（每个用户故事都有所需任务，且可独立测试）

4. **生成 tasks.md**：以 `templates/tasks-template.md` 为结构，填充：
   - 从 plan.md 获取正确的 feature 名称
   - 阶段 1：准备任务（项目初始化）
   - 阶段 2：基础设施任务（阻塞所有用户故事的前置条件）
   - 阶段 3+：每个用户故事一个阶段（按 spec.md 的优先级顺序）
   - 每个阶段包含：故事目标、独立测试标准、测试任务（如需要）、实现任务
   - 最终阶段：打磨与横切关注点
   - 所有任务必须严格遵循清单格式（见下方“任务生成规则”）
   - 每个任务都要写明清晰的文件路径
   - 包含依赖章节，展示用户故事完成顺序
   - 每个故事提供并行执行示例
   - 包含实施策略章节（MVP 优先、增量交付）

5. **汇报**：输出生成的 tasks.md 路径与摘要：
   - 任务总数
   - 每个用户故事的任务数
   - 识别出的并行机会
   - 每个用户故事的独立测试标准
   - 建议的 MVP 范围（通常只做用户故事 1）
   - 格式校验：确认所有任务都符合清单格式（checkbox、ID、标签、文件路径）

任务生成的上下文：{ARGS}

生成的 tasks.md 应可立即执行——每个任务都必须足够具体，使 LLM 在无需额外上下文的情况下也能完成。

## 任务生成规则

**关键**：任务必须按用户故事组织，以支持独立实现与独立测试。

**测试是可选的**：仅当功能规格明确要求测试，或用户要求 TDD 时才生成测试任务。

### 清单格式（必需）

每个任务都必须严格遵循以下格式：

```text
- [ ] [TaskID] [P?] [Story?] 带文件路径的描述
```

**格式组成**：

1. **复选框**：必须以 `- [ ]` 开头（Markdown checkbox）
2. **任务 ID**：按执行顺序编号（T001、T002、T003……）
3. **[P] 标记**：仅在任务可并行时使用（不同文件，且不依赖未完成任务）
4. **[Story] 标签**：仅用于用户故事阶段任务，并且是必需的
   - 格式：[US1]、[US2]、[US3]……（映射到 spec.md 的用户故事）
   - 准备阶段：不写 story 标签
   - 基础设施阶段：不写 story 标签
   - 用户故事阶段：必须写 story 标签
   - 打磨阶段：不写 story 标签
5. **描述**：清晰动作 + 精确文件路径

**示例**：

- ✅ 正确：`- [ ] T001 按实现计划创建项目结构`
- ✅ 正确：`- [ ] T005 [P] 在 src/middleware/auth.py 实现认证中间件`
- ✅ 正确：`- [ ] T012 [P] [US1] 在 src/models/user.py 创建 User model`
- ✅ 正确：`- [ ] T014 [US1] 在 src/services/user_service.py 实现 UserService`
- ❌ 错误：`- [ ] 创建 User model`（缺少任务 ID 与 Story 标签）
- ❌ 错误：`T001 [US1] 创建 model`（缺少 checkbox）
- ❌ 错误：`- [ ] [US1] 创建 User model`（缺少任务 ID）
- ❌ 错误：`- [ ] T001 [US1] 创建 model`（缺少文件路径）

### 任务组织方式

1. **来自用户故事（spec.md）** ——主要组织方式：
   - 每个用户故事（P1、P2、P3……）对应一个阶段
   - 将相关组件映射到所属用户故事：
     - 该故事所需的 models
     - 该故事所需的 services
     - 该故事所需的 endpoints/UI
     - 若要求测试：该故事专用测试
   - 标记用户故事依赖（多数故事应保持独立）

2. **来自 contracts**：
   - 将每个 contract/endpoint 映射到其服务的用户故事
   - 若要求测试：每个 contract 在对应故事阶段内应先生成 contract 测试任务（可标注 [P]），再生成实现任务

3. **来自数据模型（data model）**：
   - 将每个实体映射到需要它的用户故事
   - 若实体服务多个故事：放在最早的用户故事阶段，或放入准备阶段
   - 实体关系 → 在对应用户故事阶段生成 service 层任务

4. **来自准备/基础设施**：
   - 共享基础设施 → 准备阶段（Phase 1）
   - 阻塞性基础设施 → 基础设施阶段（Phase 2）
   - 故事专用准备 → 放入对应用户故事阶段

### 阶段结构

- **Phase 1**：准备（项目初始化）
- **Phase 2**：基础设施（阻塞性前置条件——必须在用户故事之前完成）
- **Phase 3+**：按优先级顺序的用户故事阶段（P1、P2、P3……）
  - 每个故事内部：测试（如需要）→ Models → Services → Endpoints → 集成
  - 每个阶段都应是一个完整且可独立测试的增量
- **最终阶段**：打磨与横切关注点
